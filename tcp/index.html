<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>tcp 协议 - cat3306</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="tcp 协议" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cat3306.github.io/tcp/" /><meta property="og:image" content="https://cat3306.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-11T15:45:15+08:00" />
<meta property="article:modified_time" content="2024-01-29T15:42:47+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://cat3306.github.io/logo.png"/>

<meta name="twitter:title" content="tcp 协议"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="cat3306">
<meta name="apple-mobile-web-app-title" content="cat3306"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://cat3306.github.io/tcp/" /><link rel="prev" href="https://cat3306.github.io/http/" /><link rel="next" href="https://cat3306.github.io/navicat_premium/" /><link rel="stylesheet" href="/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css" integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel="preload" href="/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0="></noscript><link rel="preload" href="/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css" integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8=" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css" integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "tcp 协议",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/cat3306.github.io\/tcp\/"
        },"genre": "posts","keywords": "网络协议","wordcount":  341 ,
        "url": "https:\/\/cat3306.github.io\/tcp\/","datePublished": "2022-01-11T15:45:15+08:00","dateModified": "2024-01-29T15:42:47+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "cat3306"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="cat3306">❤️🔞❤️</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="cat3306">❤️🔞❤️</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">tcp 协议</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>cat3306</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-01-11">2022-01-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;341 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;2 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#认识tcp">认识TCP</a></li>
    <li><a href="#tcp-连接建立">TCP 连接建立</a>
      <ul>
        <li><a href="#为什么一定是三次握手不是两次不是四次">为什么一定是三次握手，不是两次，不是四次</a>
          <ul>
            <li><a href="#原因一">原因一</a></li>
            <li><a href="#原因二">原因二</a></li>
            <li><a href="#原因三">原因三</a></li>
            <li><a href="#原因四避免资源浪费">原因四：避免资源浪费</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#认识-mtu-和-mss">认识 MTU 和 MSS</a></li>
    <li><a href="#syn攻击">SYN攻击</a>
      <ul>
        <li><a href="#避免syn攻击方法一">避免SYN攻击方法一</a></li>
        <li><a href="#避免syn攻击方法二">避免SYN攻击方法二</a></li>
      </ul>
    </li>
    <li><a href="#tcp-的四次挥手断开连接">TCP 的四次挥手，断开连接</a>
      <ul>
        <li><a href="#为什么一定要四次交互呢">为什么一定要四次交互呢</a></li>
        <li><a href="#为什么需要time_wait">为什么需要TIME_WAIT</a></li>
        <li><a href="#为什么time_wait-等待时间时2msl">为什么TIME_WAIT 等待时间时2MSL</a></li>
        <li><a href="#time_wait-过多有什么危害">TIME_WAIT 过多有什么危害</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="认识tcp">认识TCP</h2>
<p>还是那张图，tcp位于整个网络层次中的传输层</p>
<p><figure><a class="lightgallery" href="/img/net/1.png" title="/img/net/1.png" data-thumbnail="/img/net/1.png" data-sub-html="<h2>工作流程</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/net/1.png"
            data-srcset="/img/net/1.png, /img/net/1.png 1.5x, /img/net/1.png 2x"
            data-sizes="auto"
            alt="/img/net/1.png" />
    </a><figcaption class="image-caption">工作流程</figcaption>
    </figure></p>
<p>tcp报文长这个样子</p>
<p><figure><a class="lightgallery" href="/img/net/11.png" title="/img/net/11.png" data-thumbnail="/img/net/11.png" data-sub-html="<h2>工作流程</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/net/11.png"
            data-srcset="/img/net/11.png, /img/net/11.png 1.5x, /img/net/11.png 2x"
            data-sizes="auto"
            alt="/img/net/11.png" />
    </a><figcaption class="image-caption">工作流程</figcaption>
    </figure></p>
<ul>
<li><strong>源端口</strong>：是指发起连接的端口，及客户端口</li>
<li><strong>目的端口</strong>：接受方端口，服务器端口</li>
</ul>
<p>可以看出端口数量最大有2^16 -1（65535）个</p>
<ul>
<li>
<p><strong>序列号</strong>：在建立连接时由计算机生成的随机数作为其初始值，通过 SYN 包传给接收端主机，每发送一次数据，就「累加」一次该「数据字节数」的大小。用来解决网络包乱序问题。</p>
</li>
<li>
<p>确认应答号：指下一次「期望」收到的数据的序列号，发送端收到这个确认应答以后可以认为在这个序号以前的数 据都已经被正常接收。用来解决不丢包的问题。</p>
</li>
<li>
<p><strong>控制位</strong>：</p>
<ul>
<li>
<p><strong>ACK</strong> ，该位为1时，确认应答」的字段变为有效，TCP 规定除了最初建立连接时的 SYN 包之外该位必须 设置为 1 。</p>
</li>
<li>
<p><strong>RST</strong> ，该位为1时，表示TCP连接中出现异常必须强制断开连接</p>
</li>
<li>
<p><strong>SYN</strong>，该位为1时，表示希望建立连接，并在其「序列号」的字段进行序列号初始值的设定。</p>
</li>
<li>
<p><strong>FIN</strong>，该位为1时，表示希望今后不会再有数据发送，希望断开连接，当通信结束希望断开连接时，通信双方的主 机之间就可以相互交换 FIN 位为 1 的 TCP 段。</p>
</li>
</ul>
</li>
</ul>
<p>事实上，tcp协议很复杂，因为tcp定位是可靠的传输协议。由于IP层不可靠，它不保证网络包的交付、不保证网络包的按序交付、也不保证网络包中的数据的完整性。TCP 是面向连接的、可靠的、基于字节流的传输层通信协议。</p>
<ul>
<li>面向连接：一定是一对一才能连接，是成对出现，不像UDP一样可以一个主机同时向多个主机发送消息。</li>
<li>可靠的：无论网络情况有多复杂，TCP 都可以保证一个报文一定能够到达接收端，</li>
<li>字节流：消息是没有边界，像流水一样。所以，需要应用层进行数据分割。http协议的换行符，和header里面的content-length 都是同一个目的，为了区分这次请求返回的数据界限。再比如，基于游戏服务的数据格式，需要留四位(int32)用于分包，处理正确的数据包。消息是「没有边界」的，所以无论我们消息有多大都可以进行传输。并且消息是「有序的」，当「前 一个」消息没有收到的时候，即使它先收到了后面的字节，那么也不能扔给应用层去处理，同时对「􏰀复」的 报文会自动丢弃。</li>
</ul>
<p>简单来说就是，用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括<strong>Socket</strong>、序列号和窗口 大小称为连接。</p>
<p><figure><a class="lightgallery" href="/img/net/12.png" title="/img/net/12.png" data-thumbnail="/img/net/12.png" data-sub-html="<h2>工作流程</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/net/12.png"
            data-srcset="/img/net/12.png, /img/net/12.png 1.5x, /img/net/12.png 2x"
            data-sizes="auto"
            alt="/img/net/12.png" />
    </a><figcaption class="image-caption">工作流程</figcaption>
    </figure></p>
<ul>
<li>socket：由 IP 地址和端口号组成</li>
<li>序列号：用来解决乱序问题等</li>
<li>窗口大小：用来做流量控制</li>
</ul>
<p>TCP 通过四元组可以唯一确定一个链接</p>
<ul>
<li>源IP</li>
<li>目的IP</li>
<li>源端口</li>
<li>目的端口</li>
</ul>
<p>源IP和目的IP（32位）是通过IP协议发送IP数据报给对方主机</p>
<p>理论上client最多可以和65536-1（2^16-1）个server ip相连</p>
<p>理论上server最多可以和2^48( 2^32*2^16 )client相连，对 IPv4，客户端的 IP 数最多为 2 的 32 次方，客户端的端口数最多为 2 的 16 次方，也就是服务端单机最大 TCP 连接数，约为 2 的 48 次方。当然这只是理论，实际上远远达不到这么多的连接数</p>
<ul>
<li>首先主要是文件描述符限制，Socket 都是文件，所以首先要通过 ulimit 配置文件描述符的数目;</li>
<li>另一个是内存限制，每个 TCP 连接都要占用一定内存，操作系统的内存是有限的。</li>
</ul>
<p>TCP数据长度=IP总长度-IP首部长度-TCP首部长度</p>
<h2 id="tcp-连接建立">TCP 连接建立</h2>
<p>TCP 是面向连接的协议，所以使用 TCP 前必须先建立连接，而建立连接是通过三次握手来进行的。
<figure><a class="lightgallery" href="/img/net/13.png" title="/img/net/13.png" data-thumbnail="/img/net/13.png" data-sub-html="<h2>工作流程</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/net/13.png"
            data-srcset="/img/net/13.png, /img/net/13.png 1.5x, /img/net/13.png 2x"
            data-sizes="auto"
            alt="/img/net/13.png" />
    </a><figcaption class="image-caption">工作流程</figcaption>
    </figure></p>
<ul>
<li>
<p>开始的时候，服务器和客户端都出于<code>CLOSED</code>状态。服务器监听某个端口，出于``LISTEN` 状态</p>
</li>
<li>
<p>第一次握手：客户端是随机初始化序号（client_isn）,并将这个序号填入TCP首部的序号字段中，同时把控制位SYN置为1，表示SYN报文。做完这些，将这个报文发给服务器，表示向服务器发起连接，<mark>该报文不包含应用数据</mark>，之后客户端出于<code>SYN-SENT</code> 状态</p>
<p><figure><a class="lightgallery" href="/img/net/14.png" title="/img/net/14.png" data-thumbnail="/img/net/14.png" data-sub-html="<h2>工作流程</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/net/14.png"
            data-srcset="/img/net/14.png, /img/net/14.png 1.5x, /img/net/14.png 2x"
            data-sizes="auto"
            alt="/img/net/14.png" />
    </a><figcaption class="image-caption">工作流程</figcaption>
    </figure></p>
</li>
<li>
<p>第二次握手：服务端收到客户端的<code>SYN</code> 报文后，服务器也随机初始化一个序号（server_isn），将序号填充TCP首部的序号字段中，然后把<code>client_isn+1</code>填入TCP首部的「确认应答号」字段中，并把<code>SYN</code> 和 <code>ACK</code> 标志位置为1。最后把该报文发给客户端，<mark>该报文不包含应用数据</mark>，服务器此时处于<code>SYN-RCVD</code> 状态
<figure><a class="lightgallery" href="/img/net/15.png" title="/img/net/15.png" data-thumbnail="/img/net/15.png" data-sub-html="<h2>工作流程</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/net/15.png"
            data-srcset="/img/net/15.png, /img/net/15.png 1.5x, /img/net/15.png 2x"
            data-sizes="auto"
            alt="/img/net/15.png" />
    </a><figcaption class="image-caption">工作流程</figcaption>
    </figure></p>
</li>
<li>
<p>第三次握手：客户端收到服务器发送的<code>SYN/ACK</code> 报文后，还需要给服务器一个应答报文，及<code>ACK</code> 报文。首先该应答报文 TCP 首部 ACK 标志位置为1 ，其次「确认应答号」字段填入<code>server_isn+1</code> 最后将这个报文发个服务器，这次报文<mark>可以携带应用数据</mark>，之后客户端出于<code>ESTABLISHED</code>状态，服务器收到客户端的应答报文后，也进入<code>ESTABLISHED</code>状态
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/16.png"
        data-srcset="/img/net/16.png, /img/net/16.png 1.5x, /img/net/16.png 2x"
        data-sizes="auto"
        alt="/img/net/16.png"
        title="/img/net/16.png" /></p>
</li>
</ul>
<p>一旦完成三次握手，双方都处于<code>ESTABLISHED</code>状态，此时连接已经建立完成，客户端和服务端就可以互相发数据了。TCP 的连接状态查看，在 Linux 可以通过 netstat -napt 命令查看。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/17.png"
        data-srcset="/img/net/17.png, /img/net/17.png 1.5x, /img/net/17.png 2x"
        data-sizes="auto"
        alt="/img/net/17.png"
        title="/img/net/17.png" /></p>
<h3 id="为什么一定是三次握手不是两次不是四次">为什么一定是三次握手，不是两次，不是四次</h3>
<p>很常见的回答是：只有三次握手才能保证双方的接受能力和发送能力
这不是主要原因</p>
<ul>
<li>三次握手才可以阻止重复历史连接的初始化（主要原因）</li>
<li>三次握手才可以同步双方的初始化序列号</li>
<li>三次握手才可以避免资源浪费</li>
</ul>
<h4 id="原因一">原因一</h4>
<p>三次握手最重要的原因是防止旧的重复连接初始化造成混乱
实际上的网络环境错综复杂，有可能旧的数据包先到达目的主机，这会造成连接混乱。为了规避这个问题，才有了三次握手
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/18.png"
        data-srcset="/img/net/18.png, /img/net/18.png 1.5x, /img/net/18.png 2x"
        data-sizes="auto"
        alt="/img/net/18.png"
        title="/img/net/18.png" />
在网络拥堵的情况下，客户端连续发起多次SYN建立连接的报文</p>
<ul>
<li>一个旧的SYN报文比最新的SYN报文早到达服务器</li>
<li>此时服务会回一个SYN/ACK 报文给客户端</li>
<li>客户端收到后根据自身的上下文，判断是否是个历史连接。三次握手巧就巧在，客户端可以根据情况来告诉服务器
<ul>
<li>如果是历史连接，则发一个<code>RST </code>报文，终止历史连接</li>
<li>如果不是历史连接，则发一个<code>ACK</code>报文。双发进入<code>ESTABLISHED</code></li>
</ul>
</li>
</ul>
<h4 id="原因二">原因二</h4>
<p>TCP 协议的通信双方，都必须维护一个序列号，序列号是可靠传输的关键因素</p>
<ul>
<li>接收方可以去除重复数据</li>
<li>接收方可以根据数据包的序列号接收</li>
<li>可以标识发出去的数据包中，哪些是已经被对方收到的</li>
</ul>
<p>可以看见，序列号和应答号很重要，当客户端发送带有初始化序列号的SYN 时候，需要服务端回一个带有应答号的ACK报文，标识客户端的SYN报文已被服务器成功接收，当服务器发送初始化序列号SYN包给客户端时候，客户端也需要回一个ACK报文。这样一来一回才能确保双方的初始化序列号可能被可靠同步</p>
<h4 id="原因三">原因三</h4>
<p>四次握手可以满足tcp连接要求，但是没有必要</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/19.png"
        data-srcset="/img/net/19.png, /img/net/19.png 1.5x, /img/net/19.png 2x"
        data-sizes="auto"
        alt="/img/net/19.png"
        title="/img/net/19.png" /></p>
<h4 id="原因四避免资源浪费">原因四：避免资源浪费</h4>
<p>如果是两次握手，当客户端的SYN报文在网络中阻塞，客户端由于没有收到服务的ACK报文，就会重新发送SYN报文。服务器收到一个SYN就会回一个ACK报文然后建立连接，就会造成资源浪费的情况
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/20.png"
        data-srcset="/img/net/20.png, /img/net/20.png 1.5x, /img/net/20.png 2x"
        data-sizes="auto"
        alt="/img/net/20.png"
        title="/img/net/20.png" /></p>
<h2 id="认识-mtu-和-mss">认识 MTU 和 MSS</h2>
<ul>
<li>MTU：（Maximum Transmission Unit）最大传输单元，一个网络包的最大的长度，以太网一般为1500字节</li>
<li>MSS：除去IP和TCP头部之后，一个网络包所能容纳的TCP数据的最大长度</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/21.png"
        data-srcset="/img/net/21.png, /img/net/21.png 1.5x, /img/net/21.png 2x"
        data-sizes="auto"
        alt="/img/net/21.png"
        title="/img/net/21.png" /></p>
<p>如果TCP的整个报文（头部+数据）交给IP层进行分片，会怎么样</p>
<p>当IP层有一个超过MTU大小的数据（TCP头部和TCP数据）要发送时，IP层就会进行分片，把数据分成若干片，保证每一分片都小于MTU，最后有目的进行重新组装。再交给上一层TCP传输层。这样有个问题如果一个IP分片丢失，整个IP报文的所有分片都要重传。因为一个大的TCP报文被MTU分片，那么只有第一个分片才具有TCP头部，后面的分片则没有TCP头部，接受方IP层只有重组装这些分片，才发现是个TCP报文，如果丢失了其中一个分片，接受方IP层不会把TCP报文丢给TCP层，会等待对方超时重传整个TCP报文。
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/23.png"
        data-srcset="/img/net/23.png, /img/net/23.png 1.5x, /img/net/23.png 2x"
        data-sizes="auto"
        alt="/img/net/23.png"
        title="/img/net/23.png" /></p>
<p>但是如果一个大的TCP报文被MSS分片，那么所有的分片都具有TCP头部，这样一来其中一个MSS分片丢失，只需要重传一个分片就可以了。
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/22.png"
        data-srcset="/img/net/22.png, /img/net/22.png 1.5x, /img/net/22.png 2x"
        data-sizes="auto"
        alt="/img/net/22.png"
        title="/img/net/22.png" />
为了达到最佳的传输效能 TCP 协议在建立连接的时候通常要协商双方的 <strong>MSS</strong> 值，当 TCP 层发现数据超过MSS 时，则就先会进行分片，当然由它形成的 IP 包的⻓度也就不会大于 MTU ，自然也就不用 IP 分片了。</p>
<h2 id="syn攻击">SYN攻击</h2>
<p>TCP的连接建立需要三次握手，假设攻击者短时间内伪造了不同的IP地址的SYN报文，服务器接收后就进入SYN_RCVD 状态。但服务端发送出去的ACK/SYN 报文，无法得到未知IP主机的ACK应答，久而久之就会占满服务端的SYN接收队列（未连接队列），使得服务器不能为正常的用户服务
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/24.png"
        data-srcset="/img/net/24.png, /img/net/24.png 1.5x, /img/net/24.png 2x"
        data-sizes="auto"
        alt="/img/net/24.png"
        title="/img/net/24.png" /></p>
<h3 id="避免syn攻击方法一">避免SYN攻击方法一</h3>
<p>通过修改Linux 内核参数，控制队列大小和当队列满是应该怎么处理</p>
<p><mark>查看内核参数</mark></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sysctl -a | grep netdev_max_backlog
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>SYN_RCVD 状态连接的最大个数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat /etc/sysctl.conf <span class="p">|</span> grep net.ipv4.tcp_max_syn_backlog
</span></span><span class="line"><span class="cl">net.ipv4.tcp_max_syn_backlog <span class="o">=</span> <span class="m">1024</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>超出处理能时，对新的 SYN 直接回报 RST，丢弃连接:
当TCP连接已经建立，并塞到程序监听backlog队列时，如果检测到backlog队列已经满员后，TCP连接状态会回退到<code>SYN+ACK</code>状态，假装TCP三次握手第三次客户端的<code>ACK</code>包没收到，让客户端重传<code>ACK</code>，以便快速进入<code>ESTABLISHED</code>状态。如果设置了<code>net.ipv4.tcp_abort_on_overflow</code>参数，那么在检测到监听backlog 队列已满时，直接发 RST 包给客户端终止此连接，此时客户端程序会收到<code>104 Connection reset by peer</code>错误。这个参数很暴力，慎用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">net.ipv4.tcp_abort_on_overflow
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#参数表示网卡接受数据包的队列最大长度，在阿里云服务器上，默认值是1000，可以适当调整。</span>
</span></span><span class="line"><span class="cl">net.core.netdev_max_backlog
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="避免syn攻击方法二">避免SYN攻击方法二</h3>
<p>Linux 内核的SYN （未完成连接建立）队列与Accept（已完成连接建立）队列是如何工作的？
正常流程：</p>
<ul>
<li>当服务端接收到了客户端发的SYN报文时，会将其放入内核的SYN队列中</li>
<li>接着发送SYN+ACK 给客户端，等待客户端回应ACK报文</li>
<li>服务端接收到ACK报文后，从SYN队列移除到Accept队列</li>
<li>应用通过调用accept() socket 接口，从Accept队列取出连接。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/25.png"
        data-srcset="/img/net/25.png, /img/net/25.png 1.5x, /img/net/25.png 2x"
        data-sizes="auto"
        alt="/img/net/25.png"
        title="/img/net/25.png" /></p>
<p>当应用程序处理，就会导致Accept队列被占满，SYN队列也被占满
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/26.png"
        data-srcset="/img/net/26.png, /img/net/26.png 1.5x, /img/net/26.png 2x"
        data-sizes="auto"
        alt="/img/net/26.png"
        title="/img/net/26.png" />
当服务端受到SYN攻击时，SYN队列会被占满
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/27.png"
        data-srcset="/img/net/27.png, /img/net/27.png 1.5x, /img/net/27.png 2x"
        data-sizes="auto"
        alt="/img/net/27.png"
        title="/img/net/27.png" /></p>
<p>内核参数<code>tcp_syncookies</code> 的方式可以应对SYN攻击</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">net.ipv4.tcp_syncookies <span class="o">=</span> <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>当SYN队列被占满后，后续的服务端收到SYN报文，不进入SYN队列</li>
<li>计算出一个cookie 值，再以SYN+ACK 中的序列号返回客户端</li>
<li>服务端接收客户端的ACK报文，服务端会检查ACK包的合法性。如果合法，直接Accept 队列</li>
<li>最后应用通过调用 accpet() socket 接口，从「 Accept 队列」取出的连接。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/28.png"
        data-srcset="/img/net/28.png, /img/net/28.png 1.5x, /img/net/28.png 2x"
        data-sizes="auto"
        alt="/img/net/28.png"
        title="/img/net/28.png" /></p>
<h2 id="tcp-的四次挥手断开连接">TCP 的四次挥手，断开连接</h2>
<p>双方都可以主动断开连接，断开后主机的资源将被释放</p>
<ul>
<li>客户端打算关闭连接，此时会发送一个TCP头部<code>FIN</code> 标志位被置为1 的报文，也就是FIN报文，之后客户端进入FIN_WAIT_1 状态</li>
<li>服务端收到报文后，就向客户端发送ACK应答报文，接着服务端进入CLOSED_WAIT 状态</li>
<li>客户端收到ACK报文后进入FIN_WAIT_2状态。</li>
<li>等服务端处理完数据后，会向客户端发送FIN报文，之后进入LAST_ACK 状态</li>
<li>客户端收到服务端的FIN报文后，回一个ACK报文，进入TIME_WAIT 状态</li>
<li>服务器收到了ACK报文后，进入CLOSED状态，至此服务端已经完成了连接的关闭</li>
<li>客户端在经过2MSL 一段时间后，自动进入CLOSED状态，至此客户端已经完成了连接的关闭</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/29.png"
        data-srcset="/img/net/29.png, /img/net/29.png 1.5x, /img/net/29.png 2x"
        data-sizes="auto"
        alt="/img/net/29.png"
        title="/img/net/29.png" />
有一点需要注意的是：<strong>主动关闭连接的，才会有TIME_WAIT 状态</strong></p>
<h3 id="为什么一定要四次交互呢">为什么一定要四次交互呢</h3>
<ul>
<li>关闭连接的时候，客户端向服务端发送FIN 时，仅仅表示客户端不再发送数据了，但是还能接收。</li>
<li>服务端收到客户端的FIN报文后，先回一个ACK报文，而服务端可能还有数据需要处理和发送，等服务器不再发送数据时，才发送FIN报文给客户端表示现在关闭连接</li>
</ul>
<p>服务端通常要等待完成数据的处理和发送，所以ACK和FIN 报文会分开发送，这就是四次交互的由来</p>
<h3 id="为什么需要time_wait">为什么需要TIME_WAIT</h3>
<ul>
<li>防止具有相同的四元组的旧数据包被收到</li>
<li>保证「被动关闭连接」的一方能被正确的关闭，即保证最后的 ACK 能让被动关闭方接收，从而帮助其正常关闭。</li>
</ul>
<p>原因一：防止旧连接的数据包
如果TIME_WAIT 没有等待时间或者时间很短，被延迟的数据包抵达会发什么什么？</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/30.png"
        data-srcset="/img/net/30.png, /img/net/30.png 1.5x, /img/net/30.png 2x"
        data-sizes="auto"
        alt="/img/net/30.png"
        title="/img/net/30.png" /></p>
<p>原因二：保证连接正确关闭
TIME_WAIT 作用是等待足够的时间以确保最后的ACK能让被动关闭方接收，从而帮助其正确关闭。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/net/31.png"
        data-srcset="/img/net/31.png, /img/net/31.png 1.5x, /img/net/31.png 2x"
        data-sizes="auto"
        alt="/img/net/31.png"
        title="/img/net/31.png" /></p>
<p>如果 TIME_WAIT 等待足够长</p>
<ul>
<li>服务端正常收到四次挥手的最后一个ACK报文，则服务器正常关闭连接</li>
<li>服务端没有收到四次挥手的最后一个ACK报文，最会重发FIN，并等待新的ACK报文</li>
</ul>
<h3 id="为什么time_wait-等待时间时2msl">为什么TIME_WAIT 等待时间时2MSL</h3>
<p>MSL 全称 Maximum Segment Lifetime，报文的最大生存时间，它是任何报文在网络上的存在的最长时间，超过这个时间的报文将被丢弃。因为TCP报文是基于IP协议的，而IP头部有个TTL字段，是IP数据报可以经过的最大路由数，每经过一个处理他的路由器该值就会减一，当为0时，就会被丢弃，同时发送ICMP报文通知源主机。</p>
<p>MSL与TTL的区别：MSL的单位是时间，而TTL是经过路由的跳数。所以MSL应该大于等于TTL消耗为0 的时间，以确保报文已被自然消亡。</p>
<p>TIME_WAIT 等待2倍的MSL，比较合理的解释是：网络中可能存在来自对发送的数据包，当这些发送方的数据包被接收方处理又会向对方发送响应，一来二去正好2个MSL。</p>
<p>2MSL 的时间是从客户端发送FIN后发送ACK开始计时。如果在TIME_WAIT 时间内，因为客户端的ACK没有传输到服务器，客户端右接收到了服务端重发的FIN报文，那么2MSL时间将会重新计时。</p>
<p>在Linux系统里2MSL默认是60秒，其定义在Linux内核代码里面的名称为TCP_TIMEWAIT_LEN:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define TCP_TIMEWAIT_LEN (60*HZ) </span><span class="cm">/* how long to wait to destroy TIME-WAIT
</span></span></span><span class="line"><span class="cl"><span class="cm">                                    state, about 60 seconds  */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果要修改 TIME_WAIT 的时间⻓度，只能修改 Linux 内核代码里 TCP_TIMEWAIT_LEN 的值，并重新编译 Linux 内核</p>
<h3 id="time_wait-过多有什么危害">TIME_WAIT 过多有什么危害</h3>
<ul>
<li>内存资源占用</li>
<li>对端口资源的占用</li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-01-29</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/tcp/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://cat3306.github.io/tcp/" data-title="tcp 协议" data-hashtags="网络协议"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://cat3306.github.io/tcp/" data-hashtag="网络协议"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://cat3306.github.io/tcp/" data-title="tcp 协议"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://cat3306.github.io/tcp/" data-title="tcp 协议"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://cat3306.github.io/tcp/" data-title="tcp 协议"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/http/" class="prev" rel="prev" title="http 协议"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>http 协议</a>
            <a href="/navicat_premium/" class="next" rel="next" title="navicat 破解版">navicat 破解版<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.4">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">cat3306</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.76e39bd605d45b2d1944123c66608b0c8bb9baeb70720b212571531c7cf9bc2a.css" integrity="sha256-duOb1gXUWy0ZRBI8ZmCLDIu5uutwcgshJXFTHHz5vCo="><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q="><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.ae2da1bd62c6469ee27770ad1cddf2e8296d8a7f6d85b091463e5200c5e320af.js" integrity="sha256-ri2hvWLGRp7id3CtHN3y6Cltin9thbCRRj5SAMXjIK8="></script><script type="text/javascript" src="/lib/lunr/lunr.min.08a93c0120364b01159db3c287f39b2180bb740334472bda0675bd3f18981676.js" integrity="sha256-CKk8ASA2SwEVnbPCh/ObIYC7dAM0RyvaBnW9PxiYFnY="></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.3d9120fa621da6d613c1698b7014ec6bdf4620366e8f2b7b547059f4b6f6272b.js" integrity="sha256-PZEg+mIdptYTwWmLcBTsa99GIDZujyt7VHBZ9Lb2Jys="></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.e17a1d816e13c0826e0ed7febfabc3277f45571234bde0bf9120829a7169edc9.js" integrity="sha256-4XodgW4TwIJuDtf+v6vDJ39FVxI0veC/kSCCmnFp7ck="></script><script type="text/javascript" src="/lib/sharer/sharer.min.cc31d902aa4f3fcc8bb8c81aa534a4e2103e9b11f65b9fbd5b7156e089889ceb.js" integrity="sha256-zDHZAqpPP8yLuMgapTSk4hA+mxH2W5+9W3FW4ImInOs="></script><script type="text/javascript" src="/lib/katex/katex.min.eb18207487161674e717087c317db14ac1a62dadaecccb802499ce173bfeb739.js" integrity="sha256-6xggdIcWFnTnFwh8MX2xSsGmLa2uzMuAJJnOFzv+tzk="></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.cb7f4ca60ed5dc3e258415f8c7a3b46d4a93578a52adf83011f18a7f190e7602.js" integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.52ce78fab4860d24ef22128a52ce24ca01368a9034457a565a1d3fccbab0ddbb.js" integrity="sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.5c0a121a8b490afc85860a522347aeb34fb508c6b23044e5d29f6b2194227b51.js" integrity="sha256-XAoSGotJCvyFhgpSI0eus0+1CMayMETl0p9rIZQie1E="></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ="></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.e8d2be21e46b332dc48b46049b0c07b11a65970524ed512fac5d352f19eea7a5.js" integrity="sha256-6NK+IeRrMy3Ei0YEmwwHsRpllwUk7VEvrF01Lxnup6U="></script></body>
</html>
